---
layout: post
author: Berry Qiu
title: 计算机网络（3）——网络层
subtitle: 
date: 2020-02-17
cover: 'https://markdown-img-1306901910.cos.ap-nanjing.myqcloud.com/20221003171608.png'
tags: 
    - 计算机网络
    - 学习笔记
category: 笔记 
tips: [ARP, ICMP, IGMP, 子网, 超网, RIP, OSPF, VPN, NAT]
katex: true
---

# 网络层

## 网络层提供的服务

网络层负责在不同网络之间尽力转发数据包，基于数据包的 IP 地址转发

不负责丢失重传、不负责顺序（都是传输层的事）

## 网络设备和 OSI 参考模型

![网络设备和 OSI 参考模型1](https://markdown-img-1306901910.cos.ap-nanjing.myqcloud.com/dznc3Uwk29s7BHC.png)

![网络设备和 OSI 参考模型2](https://markdown-img-1306901910.cos.ap-nanjing.myqcloud.com/ql1j8pTsAZFHzuD.png)

发送端：

1. 应用程序准备要传输的文件
2. 传出层：将文件分段，并编号
3. 网络层：添加目标 IP 地址、源 IP 地址
4. 数据链路层两种情况：
   1. 使用自己的子网掩码，判断自己在哪个网段
   2. 使用自己的子网掩码，判断目标地址在哪个网段
   3. 如果是同一个网段，ARP协议广播解析目标 IP 地址
   4. 如果不是同一个网段，通过 ARP 协议广播解析网关 MAC 地址

## 网络层协议

![TCP/IP](https://markdown-img-1306901910.cos.ap-nanjing.myqcloud.com/3LwfZgljQp4z9nK.png)

### ARP 地址解析协议

Address Resolution Protocol，根据 IP 地址获取物理 MAC 地址

将 IP 地址通过广播（本网段），广播时目标 IP 地址是 FF-FF-FF-FF-FF-FF，即可解析目标 IP 地址的 MAC 地址。

ARP 欺骗：IP地址与 MAC 地址不对应

- 网络执法官：利用 ARP 欺骗，可控制本网段任意端的收发（提供不存在的 MAC 地址，交换机将丢弃该帧，达到两端无法通信的结果）。
- P2P终结者：控制本网段计算机上网流量

### ICMP 网际控制报文协议

Internet Control Message Protocol

#### ping命令诊断网络故障

PING（Packed Internet Grope）因特网包探索器，用于测试网络连接量的程序。Ping发送一个 ICMP 回声请求消息给目的地并报告是否收到所希望的 ICMP 回声应答。 

- TTL（Time To Live）：数据包的生存时间，每过一个路由器减 1

```powershell
ping www.baidu.com -t  		#一直 ping
ping www.baidu.com -l 200  	#指定发送数据包大小
ping www.baidu.com -i 2		#更改数据包 TTL 时间，能够跟踪数据包途径的路由器
tracert www.baidu.com
pathping www.baidu.com
```

### IGMP 网际组管理协议

Internet Group Management Protocol

- 点对点、广播、组播/多播

## IP数据包

一个 IP 数据包由**首部**和**数据**两部分组成。

### 首部

- 首部的前一部分是固定长度，20字节，是所有 IP 数据包必须具有的
- 在首部的固定部分的后面是一些可选字段，长度可变。

![首部](https://markdown-img-1306901910.cos.ap-nanjing.myqcloud.com/8EckTRA1jgbIDFQ.png)

1. 版本：0.5byte，用来表示 TCP/IP 协议的版本 v4/v6
2. 首部长度：0.5byte，说明首部的长度
3. 区分服务：1byte，类似优先级
4. 总长度：2byte，数据包总长度，故数据包最大为 65535 字节
   - 由于数据链路层最大传输数据为 1500 字节，故需要将数据包分片
   - 但是一般情况下，数据包不会超过 1500 字节。
5. 标识：2byte，标记一个完整的数据包，便于分片数据包的组装成完整的数据包。
6. 标志：3bit，标志该数据包是否为完整的数据包
   - 只有前两位有意义
   - 最低位 MF(More Fragment)，MF=1 表示后面**还有分片**，MF=0 表示是**最后一个分片**
   - 中间位 DF(Dont't Fragment)，只有 DF=0 时才**允许分片**
7. 片偏移：13bit，以**8字节为 1 个偏移单位**。
8. 生存时间：1byte，TTL，每过一个路由器减 1
   - Linux：64，WIndows：128，Unix：255
9. 协议：1byte，表示协议类型
   - ICMP：1，IGMP：2，TCP：6，UDP：17，IPv6:41，OSPF：89
10. 首部检验和：2byte，检验数据包首部在传输过程中是否出现错误。
11. 源地址/目的地址：4byte，ip地址
### ip地址的特点

1. 每一个 IP 地址都由网络号和主机号两部分组成
2. 实际上 IP 地址是标志一个主机（或路由器）和一条链路的**接口**
3. 用转发器或网桥连接起来的若干个局域网仍为一个网络。
4. 在 IP 地址中，所有分配到网络号的网络都是**平等**的

## IP协议

在互联网上转发分组时，是从**一个路由器转发到下一个路由器**。

分组转发算法（未涉及路由表的建立过程）：

1. 从数据报的首部提取目的主机的 IP 地址 D
2. 先判断是否为直接交付。对路由器直接相连的网络逐个进行检查：用各网络的子网掩码和 D 逐位相与 AND，看结果是否和相应的网络地址匹配。若匹配，则把分组进行直接交付，转发任务结束。否则就是间接交付，执行下一步
3. 若路由表中有目的地址为 D 的特定主机路由，则把数据报传送给路由表中所指明的下一跳路由器，否则执行下一步。
4. 对路由表中的每一行（目的网络地址、子网掩码、下一跳地址），用其中的子网掩码和 D 逐位与 AND，其结果为 N。若 N 与该行的目的网络地址匹配，则把数据报传送给该行指明的下一跳路由器，否则执行下一步。
5. 若路由表中有到达网络 N 的路由，则把数据报传送给路由表中所指明的下一跳路由器，否则执行下一步。
6. 若路由表中有一个默认路由，则把数据报传送给路由表中所指明的默认路由器；否则执行下一步。
7. 报告分组转发出错。

### CIDR 无分类编址(构成超网)

Classless Inter-Domain Routing 	/'saɪdə/

使 IPv4 地址被更充分利用。

书写格式：

```
192.168.144.0/20 斜线后的数字即为地址掩码/子网掩码中 1 的个数
```

由于一个 CIDR 地址块中有很多地址，所以在路由表中就利用 CIDR 地址块来查找目的网络，这种地址的聚合称为**路由聚合**，也称**构成超网**。

**使用 CIDR 时，在查找路由时可能会得到不止一个匹配结果，应当从匹配结果中选择具有最长网络前缀的路由**。

### RIP协议

Routing Information Protocol，路由信息协议

RIP 协议要求网络中的每一个路由器都要维护从它自己到其他每一个目的网络的距离记录。

距离：路由器到直接连接的网络距离为 1，每跨一个路由器，距离加 1。

RIP 允许一条路径最多只能包含 15 个路由器。因此，距离等于 16 时相当于不可达。因此只适用于小型互联网。

特点：

1. 仅和相邻路由器交换信息。
2. 路由器交换的信息是当前本路由器所知道的全部信息，即自己的路由表。
3. 按固定的时间间隔交换路由信息。一般是 30 秒。

RIP 协议使**每一个路由器到每一个目的网络的路由都是最短的（即跳数最少）**

### OSPF 协议

Open Shortest Path First，开放最短路径优先

- 以带宽为度量值
- 最短路径算法类似于 Dijkstra 算法

### BGP协议

RIP 和 OSPF 协议都是内部网关协议，用于自治系统内部路由规划，BGP 协议是外部网关协议，是不同自治系统路由器之间交换路由信息的协议。

## VPN、NAT、PAT

- Virtual Private Network，虚拟专用网络
  - 远程访问，可以从外网访问私网
- Network Address Translation，网络地址转换
  - 允许多台计算机使用一个 IP 地址访问网络。
  - 让私网能够访问外网
- Port Address Translation，端口地址转换
  - 可以看做是 NAT 的一部分
  - 大家都使用一个 IP 地址，所以需要不同的端口映射。
